#!/usr/bin/env ruby

require 'commander/import'
require 'time_log_robot'
require 'time_log_robot/version'
require 'time_log_robot/toggl/tagger'
require 'time_log_robot/toggl/report'
require 'time_log_robot/jira/payload_builder'
require 'time_log_robot/jira/work_logger'

program :name, 'time_log_robot'
program :version, TimeLogRobot::VERSION
program :description, 'Logs work from a time tracker tool to a project
management tool. Currently only supports Toggl and JIRA.'

program :help, 'Author', 'Mark J. Lehman <markopolo@gmail.com>'

global_option('-i', '--inputs_help', 'Learn how and where to find the inputs you need to get this working')

command :run do |c|
  c.syntax = 'time_log_robot run [options]'

  c.description = 'Logs your time with optional since (default is the previous Saturday).'

  c.example 'usage', 'time_log_robot run'
  c.example 'shorthand', 'time_log_robot'
  c.example 'since', 'time_log_robot run --since "2015-10-21"'

  c.option '--since STRING', String, 'The date from which to log time entries. Must be in YYYY-MM-DD format. Default is the previous Saturday.'

  c.action do |args, options|
    if options.inputs_help
      print inputs_help
    else
      missing_envars = {}

      envars = %w(
        TOGGL_TOKEN
        TOGGL_WORKSPACE_ID
        TOGGL_USER_AGENT
        TOGGL_DEFAULT_LOG_TAG
        JIRA_USERNAME
        JIRA_PASSWORD
      )

      envars.each do |key|
        unless ENV[key]
          ENV[key] = ask "Enter your #{key} (see README for how to find it): " do |char|
            char.echo = '*' if key =~ /password|token/i
          end
          if ENV[key].length == 0
            puts 'Invalid. This is a required field.'
            exit
          end
          missing_envars[key] = ENV[key]
        end
      end

      since = DateTime.parse(options.since).to_s unless options.since.nil?

      TimeLogRobot.start(since)

      if missing_envars.any?
        puts "\nTo avoid entering setup information each time, store it in environment variables:"
        missing_envars.each_pair do |key, value|
          puts "\texport #{key}=#{value}"
        end
      end
    end
  end
end

def inputs_help
  "
  TOGGL_TOKEN
    In your Toggl account, go to your profile page and look for the API token at the bottom.

  TOGGL_WORKSPACE_ID
    This is a little trickier. Your workspaces usually only show a human-readable name to you in Toggl's UI, and here you need the workspace machine ID. But you can do a curl request to find it like this (replacing TOGGL_TOKEN with your token from above):

  \tcurl -v -u TOGGL_TOKEN:api_token \ -X GET https://www.toggl.com/api/v8/workspaces

    Look at the result and find the id given for the workspace you want to use.

  TOGGL_USER_AGENT
    This is your Toggl username, usually your email.

  TOGGL_DEFAULT_LOG_TAG
    This is the tag name you would like to use for tagging your Toggl time entries as they are logged to JIRA.

  JIRA_USERNAME
    This is your JIRA username, which is not an email, but usually your email minus the '@domain.com'

  JIRA_PASSWORD
    I know there's a lot of jargon, but some of these are pretty self-explanatory
    ┌─┐
    ┴─┴
    ಠ_ರೃ
  \n"
end

# set default action for gem
default_command :run
